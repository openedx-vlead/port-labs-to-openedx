#+TITLE: Setup Analytics for Virtual-labs 
#+Author: Siva Shanker
#+Date: [2016-04-26]
#+PROPERTY: results output
#+PROPERTY: exports code
#+SETUPFILE: ../org-templates/level-1.org
#+OPTIONS: ^:nil
	   
* Introduction
  Analytics provide the user activity while using virtual labs on Open edX
  platform.  This data allows an insight into the usage of virtual labs that
  could be used for various purposes.  
* Requirements
  - Have a Open edX platform setup ready. Refer [[../platform-installation/index.org]]
  - One more VM for setting up analytics.
* Architecture of Open edX Analytics Gathering

  [[http://edx.readthedocs.org/projects/edx-installing-configuring-and-running/en/latest/_images/Analytics_Pipeline.png][Architecture Diagram]]

  Capturing of Analytics is three phased.  
  1. LMS, read as Open edX platfrom from which the labs are run, captures the
     events of a user.
  2. Pipeline reads this data from the platform, collates and creates a store
     in a format that could be read by an API.
  3. edx Analytics Data API provides an HTTP interface to access the store
     created by the Pipeline.
  4. Finally insights application will serve the analytics of courses
     which are hosted on LMS.
  The platform also exposes a [[http://edx.readthedocs.org/projects/edx-platform-api/en/latest/course_structure/index.html][set of API]] to get all the courses that are being
  run on a platform. 
* Configure Open edX analytics for the courses 
** Setup edx-analytics
   1. Create a separate VM with at least 2GB of RAM and 30GB of HDD
      for setting up edX analytics
   2. Update and upgrade the VM
      #+BEGIN_EXAMPLE
      sudo apt-get update -y
      sudo apt-get install python-pip git libmysqlclient-dev autoconf g++ python-dev 
      sudo pip install virtualenv
      #+END_EXAMPLE
   3. Create a separate virtual environment for the edx analytics setup.
      #+BEGIN_EXAMPLE
      # create an "ansible" virtualenv and activate it
      virtualenv ansible
      . ansible/bin/activate
      #+END_EXAMPLE
   4. Do the following steps
      #+BEGIN_EXAMPLE
      git clone https://github.com/edx/configuration.git
      cd configuration/
      git checkout named-release/dogwood
      pip install -r requirements.txt
      #+END_EXAMPLE
   5. Install Nodejs and npm if you are using dogwood version Open edX platform and Open edX insights
      #+BEGIN_SRC 
      sudo add-apt-repository ppa:chris-lea/node.js
      sudo apt-get update
      sudo apt-get install -y nodejs --no-install-recommends
      sudo apt-get install npm
      #+END_SRC    
   6. Run the playbook to setup insights app
      #+BEGIN_SRC 
      cd playbooks/edx-east/
      ansible-playbook -i localhost, -c local analytics_single.yml --extra-vars "INSIGHTS_LMS_BASE=https://lms.vlabs.ac.in"
      # (If your site uses https, change the scheme and set the oauth flag to true. Enforce_secure means "insist on https".)
    
    
      # wait for a while :)
      #+END_SRC
   7. Install SSL certficates 
      Follow the steps given below to add a SSL certificate in LMS machine 
      - Login to your lms machine 
      - Create a directory =certs= if it does not exist in =/etc/nginx/ssl/=
       #+BEGIN_EXAMPLE
       sudo  mkdir -p /etc/nginx/ssl/certs
       #+END_EXAMPLE
      - Change directory 
       #+BEGIN_SRC
       cd /etc/nginx/ssl/certs
       #+END_SRC
      - Copy your .crt, .key, and .ca-bundle file into =/etc/nginx/ssl/certs=
      - Modify the nginx configuration files of insights
      #+BEGIN_EXAMPLE
      vim /etc/nginx/sites-enabled/insights
      #+END_EXAMPLE
      - Add the following lines to that opened file
      #+BEGIN_EXAMPLE
      	server {
	#  listen 443 ssl default_server;
	  listen 18110 default_server;
	  server_name insights.vlabs.ac.in;

	     ssl on;
	     # ssl_certificate /etc/nginx/ssl/server.crt;
	     ssl_certificate /etc/nginx/ssl/certs/STAR_vlabs_ac_in.crt;
	     #  ssl_certificate_key /etc/nginx/ssl/server.key;
	     ssl_certificate_key /etc/nginx/ssl/certs/vlabs.ac.in.key;




	     location ~ ^/static/(?P<file>.*) {
	     root /edx/var/insights;
	     try_files /staticfiles/$file =404;
	     }

	     location / {
             try_files $uri @proxy_to_app;
	     }

	     # No basic auth security on the heartbeat url, so that ELB can use it
	     location /status {
	     try_files $uri @proxy_to_app;
	     }


	     location @proxy_to_app {
	     proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
	     proxy_set_header X-Forwarded-Port $http_x_forwarded_port;
	     proxy_set_header X-Forwarded-For $http_x_forwarded_for;
	     proxy_set_header Host $http_host;

	     #    proxy_redirect off;
	     proxy_redirect http://insights.vlabs.ac.in https://insights.vlabs.ac.in;
	     proxy_pass http://insights_app_server;
	     }

	       }

      	#+END_EXAMPLE
   8. Run the following commands to see hadoop job. This job has
      built-in "compute pi"
      #+BEGIN_EXAMPLE
      sudo su - hadoop
  
      cd /edx/app/hadoop
 
      hadoop jar hadoop-2.3.0/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.3.0.jar pi 2 100
      # it should compute something -- I got pi = 3.12. Close enough :)
      #+END_EXAMPLE
   9. Also make sure you can run hive
      #+BEGIN_EXAMPLE
      /edx/app/hadoop/hive/bin/hive
      # it should work
      ^D or exit  to get back to your regular user
      #+END_EXAMPLE
   10. The Insights app should be up. Test them by runing the following commands
       #+BEGIN_EXAMPLE
       curl https:://localhost:8110
       curl https://insights.vlabs.ac.in:18110
       #+END_EXAMPLE
   11. Get some test logs into HDFS of Insights machine from LMS machine
      
       #+BEGIN_EXAMPLE
       # scp tracking.log onto the machine from the LMS. Then...
       sudo mkdir -p /edx/var/log/tracking # if directory not exists.
       sudo scp root@<LMS-IP>:/edx/var/log/tracking/tracking.log /edx/var/log/tracking
       sudo chown hadoop /edx/var/log/tracking/tracking.log
       # wait a minute -- ansible creates a cron job to load files in that dir every minute
    
       # Check it  
       hdfs dfs -ls /data
    
       Found 1 items
       -rw-r--r--   1 hadoop supergroup     308814 2015-10-15 14:31 /data/tracking.log
       #+END_EXAMPLE
       - Exit from haddop user and get back to normal user(ubuntu)
   12. Setup PIPELINE 
	#+BEGIN_SRC 
	ssh-keygen -t rsa -f ~/.ssh/id_rsa -P ''
	echo >> ~/.ssh/authorized_keys # Make sure there's a newline at the end
	cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
	# check: ssh localhost "echo It worked!" -- make sure it works.
  
	# Make a new virtualenv -- otherwise will have conflicts
	virtualenv pipeline
	. pipeline/bin/activate
  
  
	git clone https://github.com/edx/edx-analytics-pipeline
	cd edx-analytics-pipeline
	git checkout named-release/dogwood  
	make bootstrap
    
       #+END_SRC
   13. Check the pipeline install by running a simple job to count
       events per day.

       - NOTE :: You may have to change the =--user= name and
         =--interval= in the following command according to system's
         user accounts.

       For example, If you want to run the command from root user (ssh
       access should be enabled on this user) then provide *--user
       root*
       #+BEGIN_SRC
       # Ensure you're in the pipeline virtualenv 
       remote-task --host localhost --repo https://github.com/edx/edx-analytics-pipeline --user ubuntu --override-config $HOME/edx-analytics-pipeline/config/devstack.cfg --wheel-url http://edx-wheelhouse.s3-website-us-east-1.amazonaws.com/Ubuntu/precise --remote-name analyticstack --wait TotalEventsDailyTask --interval 2015 --output-root hdfs://localhost:9000/output/ --local-scheduler
       #+END_SRC
   14. Write config files for the pipeline so that it knows where the LMS database is: 
       #+BEGIN_SRC 
       sudo vim /edx/etc/edx-analytics-pipeline/input.json
       # put in the right url and credentials for your LMS database
       # username = edxapp001
       # host = LMS machine's IP/FQDN
       # password = password of the edxapp001 user
       #+END_SRC
   
   15. Test it by running the following command. The output of the
       below command shows the mysql queries. 
       #+BEGIN_SRC 
       remote-task --host localhost --user ubuntu --remote-name analyticstack --skip-setup --wait ImportEnrollmentsIntoMysql --interval 2016 --local-scheduler
       #+END_SRC
       - If it succeeds, you'll see: 
         #+BEGIN_EXAMPLE
         sudo mysql
	 SELECT * FROM reports.course_enrollment_daily;
  
	# Should give enrollments over time. Note that this only counts enrollments in the event logs -- if you manually created users / enrollments in the DB, they won't be counted.
         #+END_EXAMPLE
   16. Now, you will now need to update variable values in
         #=/edx/etc/insights.yml= with appropriate values (that are
         #generated automatically on django admin page on LMS machine).
       #+BEGIN_SRC 
       SOCIAL_AUTH_EDX_OIDC_KEY: '<Client id from LMS>'
       SOCIAL_AUTH_EDX_OIDC_SECRET: '<Client secret FROM LMS>'
       SOCIAL_AUTH_EDX_OIDC_URL_ROOT: '<LMS URL>/oauth2'
       SOCIAL_AUTH_REDIRECT_IS_HTTPS: true
       #+END_SRC

   17. Edit open_id.py file 
       + Fire =locate= command to find the path of the open_id.py file
       #+BEGIN_SRC 
	insights # locate open_id.py
	  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.py
	  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.pyc
	  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/tests/backends/open_id.py
	  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/tests/backends/open_id.pyc                     
       #+END_SRC                                       
       + Open file
         #+BEGIN_SRC
	  sudo vim /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.py                        
         #+END_SRC                                                                                                          
       + Search for string "issuer=self.ID_TOKEN_ISSUER". This string
         #will fall in  def validate_and_return_id_token of file.

       + In try block replace
         #+BEGIN_SRC
         id_token = jwt_decode(id_token, decryption_key, audience=client_id,
                                  issuer=self.ID_TOKEN_ISSUER,
                                  algorithms=['HS256'])

                       WITH
         id_token = jwt_decode(id_token, decryption_key, audience=client_id,
                                  issuer=self.ID_TOKEN_ISSUER, options = {'verify_iat' : False,},
                                  algorithms=['HS256'])
                                                                                                                     
         #+END_SRC                                                                                                          
       + Save file
       + Compile open_id.py files
         #+BEGIN_SRC
	   insights # sudo python
	   Python 2.7.10 (default, Jun 29 2015, 22:38:23)
	   [GCC 4.6.3] on linux2
	   Type "help", "copyright", "credits" or "license" for more information.
	   >>> import py_compile
	   >>> py_compile.compile("open_id.py")
           >>> exit()                                                                                                         
         #+END_SRC                                                                                                          
   18. Restart insights app
       #+BEGIN_SRC 
       /edx/bin/supervisorctl restart all
       #+END_SRC
   19. Edit base.py file
       #+BEGIN_SRC 
	sudo vim  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/base.py                           
       #+END_SRC                                                                                                          
       + In def request(self, url, method='GET', *args, **kwargs):, add the   following line. This line says that please do not verify SSL.
         #+BEGIN_SRC 
	  kwargs.setdefault('headers', {})
	  if self.setting('VERIFY_SSL') is not None:
             		kwargs.setdefault('verify',self.setting('VERIFY_SSL'))
          kwargs.setdefault('verify', False) ## This line needs to bee added
	  kwargs.setdefault('timeout', self.setting('REQUESTS_TIMEOUT') or
                                    self.setting('URLOPEN_TIMEOUT'))                                                
         #+END_SRC                                                                                                          
       + In the same def in try block, replace as shown. This is to ignore
         SSL_PROTOCOL even if it is there.
         #+BEGIN_SRC
         if self.SSL_PROTOCOL
         WITH
         if self.SSL_PROTOCOL is not None:                                                                                  
         #+END_SRC                                                                                                          
       + In the same try block, add line in else section
         #+BEGIN_SRC
	  else:
	      response = request(method, url, *args, **kwargs) 
         #+END_SRC                                       

       + Finally your def function looks like the one shown
       below. Please see the commented lines.
       #+BEGIN_SRC
        def request(self, url, method='GET', *args, **kwargs):
      	      kwargs.setdefault('headers', {})
	      if self.setting('VERIFY_SSL') is not None:
                  kwargs.setdefault('verify', self.setting('VERIFY_SSL'))
              kwargs.setdefault('verify', False) #Added by Dr. Ramesh
              kwargs.setdefault('timeout', self.setting('REQUESTS_TIMEOUT') or
                                           self.setting('URLOPEN_TIMEOUT'))
              if self.SEND_USER_AGENT and 'User-Agent' not in kwargs['headers']:
                  kwargs['headers']['User-Agent'] = user_agent()

              try:
                  if self.SSL_PROTOCOL is not None: #Modified to not none
                #session = SSLHttpAdapter.ssl_adapter_session(self.SSL_PROTOCOL)
                #response = session.request(method, url, *args, **kwargs)
                      response = request(method, url, *args, **kwargs)
                  else:
                      response = request(method, url, *args, **kwargs)
              except ConnectionError as err:
	      	  raise AuthFailed(self, str(err))
              response.raise_for_status()
              return response                                                                                              
       #+END_SRC                                                                                                          
       + Save file and compile it.
         #+BEGIN_SRC
	  insights # sudo python
 	  Python 2.7.10 (default, Jun 29 2015, 22:38:23)
	  [GCC 4.6.3] on linux2
          Type "help", "copyright", "credits" or "license" for more
          information.
          >>> import py_compile
          >>> py_compile.compile("base.py")
          >>> exit()                                                                                                         
         #+END_SRC                                                                                                          
       + Restart edx services
         #+BEGIN_SRC
       	 sudo /edx/bin/supervisorctl restart all                                                                            
         #+END_SRC                                 

   20. References
       - https://openedx.atlassian.net/wiki/display/OpenOPS/edX+Analytics+Installation
       - https://openedx.atlassian.net/wiki/pages/viewpage.action?spaceKey=AN&title=Configuring+Insights+for+Open+ID+Connect+SSO+with+LMS
   
** Test LMS and Insights for analytics
    - *Page Not Found* :: 
      + Log into LMS as a staff@example.com 
      + Select any course
      + Navigate to course analytics button/link (Click on instructor
        button)
      + Redirects to LMS machine to see the analytics.
      + Page not found  

* Mrs.Sukla's suggestions on setting up Open edX analytics
  - Install edx with all necessary modules like course_discovery,
     oauth_client_setup,

  - Create dns names for lms, insights & preferrably cms services

  - Create the ssl certificates for both lms & insights on the
    respective machines under /etc/nginx/ssl directory

  - Change the configuration files for lms, insights under the
    /edx/app/nginx/sites­available on both machines for https protocol
    which will use the above certificates

  - Change the configuration files for lms & insights on respective
    machine. Configuration file for lms is
    /edx/app/edxapp/lms.env.json & for insights is
    /edx/etc/insights.yml to reflect the proper urls.

  - Edit the properties of trusted insights client created during
    installation using the lms admin,change the urls with the correct
    url (url & redirect url)

  - Synchronize the computer times of both insights & edx machine using
    'ntp'

  - Append the lms nginx certificate to the file
    /edx/app/insights/venvs/insights/lib/pyhton2.7/requests/cacert.pem

  - Restart all services under supervisorctl & nginx service on both
    machines
** Work on setting up Open edX analytics based on Mrs.Sukla's suggestions 
   - Used following link to generate self-signed certificate on both
     LMS and insights machines.
     https://www.digitalocean.com/community/tutorials/how-to-create-a-ssl-certificate-on-nginx-for-ubuntu-12-04
   - Yogesh and I tried setting up Open edX analytics using
     Mrs.Sukla's suggestions, but the issue is not solved.
   - Once again I alone have tried to setup Open edX analytics using
     the  steps/suggestions provided by Mrs.Sukla. But the issue is
     not resolved.

* After we met Mr.Ramesh (APSSDC), done the following steps
  - Made entries in public and private dns servers of VLEAD
    infrastructure to provide proper
    dns names.
    + =lms.vlabs.ac.in= 
    + =insights.vlabs.ac.in=
  - Update ssl certificates(which are purchased from NameCheap
    Account) on both LMS and Insights machines as recommended by
    [[https://openedx.atlassian.net/wiki/display/OpenOPS/edX+Analytics+Installation][Confluence]]. 
  - Modify ngnix configuration files as follows
    + *On LMS machine* : 
      1. Add certificates to =/etc/nginx/ssl/certs/= folder
      2. Open the following file 
	 #+BEGIN_EXAMPLE
	 vim /edx/app/nginx/sites-available/lms
	 #+END_EXAMPLE
      3. Edit/Add the following lines to above file to make it working with https 
      	 #+BEGIN_EXAMPLE
      	 server {
	   # LMS configuration file for nginx, templated by ansible
	   
  	   
  # error p	ages
  error_page 504	 /server/server-error.html;
  error_page 502 /server/server-error.html;
  error_page 500 /server/server-error.html;
  
  listen 443 ssl default;
  server_name lms.vlabs.ac.in;

  ssl on;
 # ssl_certificate /etc/nginx/ssl/server.crt;
  ssl_certificate /etc/nginx/ssl/certs/STAR_vlabs_ac_in.crt;
#  ssl_certificate_key /etc/nginx/ssl/server.key; 
  ssl_certificate_key /etc/nginx/ssl/certs/vlabs.ac.in.key; 
    
  access_log /edx/var/log/nginx/access.log p_combined;
  error_log /edx/var/log/nginx/error.log error;

  # CS184 requires uploads of up to 4MB for submitting screenshots.
  # CMS requires larger value for course assest, values provided
  # via hiera.
  client_max_body_size 4M;

  rewrite ^(.*)/favicon.ico$ /static/images/favicon.ico last;

  location @proxy_to_lms_app {
        proxy_set_header X-Forwarded-Proto $scheme;
    	proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $http_host;

    proxy_redirect off;
    proxy_pass http://lms-backend;
  }

  location / {
        try_files $uri @proxy_to_lms_app;
  }


  # No basic auth for /segmentio/event
  location /segmentio/event {
    try_files $uri @proxy_to_lms_app;
  }

  # The api is accessed using OAUTH2 which
  # uses the authorization header so we can't have
  # basic auth on it as well.
  location /api {
    try_files $uri @proxy_to_lms_app;
  }

  # Need a separate location for the image uploads endpoint to limit upload sizes
  location ~ ^/api/profile_images/[^/]*/[^/]*/upload$ {
    try_files $uri @proxy_to_lms_app;
    client_max_body_size 1049576;
  }

  location /notifier_api {
    try_files $uri @proxy_to_lms_app;
  }

  location /user_api {
    try_files $uri @proxy_to_lms_app;
  }

  # No basic auth security on the github_service_hook url, so that github can use it for cms
  location /github_service_hook {
    try_files $uri @proxy_to_lms_app;
  }

  # No basic auth security on oauth2 endpoint
  location /oauth2 {
    try_files $uri @proxy_to_lms_app;
  }

  # No basic auth security on third party auth endpoints
  location /auth {
    try_files $uri @proxy_to_lms_app;
  }


  # No basic auth security on the heartbeat url, so that ELB can use it
  location /heartbeat {
    try_files $uri @proxy_to_lms_app;
  }

  # No basic auth on the LTI provider endpoint, it does OAuth1
  location /lti_provider {
    try_files $uri @proxy_to_lms_app;
  }

  # No basic auth on LTI component grade.
  location ~ /handler_noauth {
    try_files $uri @proxy_to_lms_app;
  }

  location /courses {    try_files $uri @proxy_to_lms_app;
  }

location ~ ^/media/(?P<file>.*) {
    root /edx/var/edxapp/media;
    try_files /$file =404;
    expires 31536000s;
}

      # static pages for server status
  location ~ ^/server/(?P<file>.*) {
      root /edx/var/nginx/server-static;
      try_files /$file =404;
  }

  location ~ ^/static/(?P<file>.*) {
    root /edx/var/edxapp;
    try_files /staticfiles/$file /course_static/$file =404;

    # return a 403 for static files that shouldn't be
    # in the staticfiles directory
    location ~ ^/static/(?:.*)(?:\.xml|\.json|README.TXT) {
        return 403;
    }

    # http://www.red-team-design.com/firefox-doesnt-allow-cross-domain-fonts-by-default
    location ~ "/static/(?P<collected>.*\.[0-9a-f]{12}\.(eot|otf|ttf|woff|woff2)$)" {
        expires max;
        add_header Access-Control-Allow-Origin *;
        try_files /staticfiles/$collected /course_static/$collected =404;
    }

    # Set django-pipelined files to maximum cache time
    location ~ "/static/(?P<collected>.*\.[0-9a-f]{12}\..*)" {
        expires max;
        # Without this try_files, files that have been run through
        # django-pipeline return 404s
        try_files /staticfiles/$collected /course_static/$collected =404;
    }

    # Set django-pipelined files for studio to maximum cache time
    location ~ "/static/(?P<collected>[0-9a-f]{7}/.*)" {
        expires max;

        # Without this try_files, files that have been run through
        # django-pipeline return 404s
        try_files /staticfiles/$collected /course_static/$collected =404;
    }

    # Expire other static files immediately (there should be very few / none of these)
    expires epoch;
  }


}

      	 #+END_EXAMPLE
      - Restart the nginx server
      	#+BEGIN_EXAMPLE
      	/etc/init.d/nginx restart
      	#+END_EXAMPLE

	
* Open Issues on GitHub
  Open Issues on GitHub regarding analytics/insights setup.  At
  present, there is only one open issue, that is
  https://github.com/vlead/port-labs-to-openedx/issues/4
>>>>>>> Stashed changes

** Problems identified in current Analytics configuration
*** OAuth trust issues between Insights and LMS 
We were unable to build a trust between Client application(Analaytics) and
Resource Server(LMS).The ideal process which should happen is given below -


**** Process 
+ Client -> Insights/Analytics machine -> Client application   
+ Server -> LMS/CMS machine -> Resource Server

+ When a client applications wants access to the resources of a resource owner,
  hosted on a resource server, the client application must first obtain an
  authorization grant.
+ Before a client application can request access to resources on a resource
  server, the client application must first register with the authorization
  server associated with the resource server.
+ The registration is typically a one-time task. Once registered, the
  registration remains valid, unless the client app registration is revoked.
+ At registration the client application is assigned a client ID and a client
  secret (password) by the authorization server.
+ The client ID and secret is unique to the client application on that
  authorization server.
+ If a client application registers with multiple authorization servers
  (e.g. both Facebook, Twitter and Google), each authorization server will
  issue its own unique client ID to the client application.
+ Whenever the client application requests access to resources stored on that
  same resource server, the client application needs to authenticate itself by
  sending along the client ID and the client secret to the autorhization
  server.
+ Whenever the client application requests access to resources stored on that
  same resource server, the client application needs to authenticate itself by
  sending along the client ID and the client secret to the autorhization
  server.

*** SSL certificate issues
+ We were using https protocol without using SSL certificates configured in web
server of LMS and Analytics machine. A SSL certificate issued by Certification
Authority(CA) is required to urgently required to get someone approve your
claim of who you are .
+ We were using Self-Signed certificates, which can be okay on local machines
  within the network, but not in global internet.
+ [[https://www.sslshopper.com/what-is-ssl.html][Understand SSL here]]

*** Client machine(Analytics) was not verifying the SSL certificate  
Insights machine was itself not verifying the SSL certificate from CA
authority. As a result we were getting the following error in /edx/var/log/insights/edx.log
#+BEGIN_SRC error
 File "/edx/app/insights/venvs/insights/local/lib/python2.7/site-packages/social/backends/oauth.py", line 383, in auth_complete
    method=self.ACCESS_TOKEN_METHOD
  File "/edx/app/insights/venvs/insights/local/lib/python2.7/site-packages/social/backends/open_id.py", line 360, in request_access_token
    response = self.get_json(*args, **kwargs)
  File "/edx/app/insights/venvs/insights/local/lib/python2.7/site-packages/social/backends/base.py", line 229, in get_json
    return self.request(url, *args, **kwargs).json()
  File "/edx/app/insights/venvs/insights/local/lib/python2.7/site-packages/social/backends/base.py", line 224, in request
    raise AuthFailed(self, str(err))
AuthFailed: Authentication failed: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:590)
#+END_SRC
When tried with curl command, we obtained following error 
#+BEGIN_SRC error
curl https://lms.vlabs.ac.in
curl: (51) SSL: certificate verification failed (result: 5)
#+END_SRC


*** Any change in .py files of should the be followed by compilation of files 
We were changing some python files and identified that applied changes were not
coming into effect. As a result it was identified that, changes to be applied
will only come in effect after compilation of .py to.pyc files.

** Solutions to address above mentioned problems 
+ Replace IP address with domain names :: 
  Public IP address was issued a domain name. 
+ Make changes in lms.env.json file in LMS server ::
  + Login into LMS server
  + Open file lms.env.json
  #+BEGIN_SRC command
  a. vim /edx/app/edxapp/lms.env.json
  #+END_SRC
  + Search and Replace 
  #+BEGIN_SRC command
  "ANALYTICS_DASHBOARD_URL":"https://your-insights.domain.com:18110"
  "ANALYTICS_SERVER_URL": "https://your-insights.domain.com:18110"
  "ENABLE_OAUTH2": true,
  "ENABLE_OAUTH2_PROVIDER": true
  "JWT_ISSUER": "https://your-lms.domain.com/oauth2"
  "OAUTH_ENFORCE_SECURE": true,
  "ENABLE_OAUTH2": true,
  "OAUTH_OIDC_ISSUER": "https://your-lms.domain.com/oauth2"
  #+END_SRC
  + Save file and restart edx services 
  #+BEGIN_SRC command
  sudo /edx/bin/supervisorctl restart all 
  #+END_SRC 
+ Make changes in cms.env.json file in LMS server :: 
  + Login into LMS server
  + Open file cms.env.json
  #+BEGIN_SRC command
  a. vim /edx/app/edxapp/cms.env.json
  #+END_SRC
  + Search and Replace 
  #+BEGIN_SRC command
  "ANALYTICS_DASHBOARD_URL":"https://your-insights.domain.com:18110"
  "ANALYTICS_SERVER_URL": ""
  "JWT_ISSUER": "https://your-lms.domain.com/oauth2"
  #+END_SRC
  + Save file and restart edx services 
  #+BEGIN_SRC command
  sudo /edx/bin/supervisorctl restart all 
  #+END_SRC
+ Install SSL certificte in LMS server, i.e. in ngnix :: 
   Follow the steps given below to add a SSL certificate in LMS machine 

   +. Login to your lms machine 
   +. Change directory 
   #+BEGIN_SRC command
   cd /etc/nginx/ssl/certs
   #+END_SRC
   +. Copy your .crt, .key, and .ca-bundle file in /etc/nginx/ssl/certs. Create directory *certs* if it does not exist.
   +. Change directory
   #+BEGIN_SRC command
   cd /etc/nginx/sites-enabled
   #+END_SRC
   +. Open file lms and make following changes in server block of file 
   #+BEGIN_SRC command
   a. vim lms
   b. server_name your-server-domain-name;
   c. ssl_certificate /path/to/your/crt/file/.crt;
   d. ssl_certificate_key /path/to/your/key/file/.key;
   #+END_SRC 
   +. Restart ngnix services 
   #+BEGIN_SRC command
   service ngnix restart 
   #+END_SRC
   +. Restart edx services 
   #+BEGIN_SRC command
   sudo /edx/bin/supervisorctl restart all
   #+END_SRC
+ Install SSL certificate in Analytics Server, i.e. in ngninx ::
   Follow the steps given below to add a SSL certificate in LMS machine 

   +. Login to your insights machine 
   +. Change directory 
   #+BEGIN_SRC command
   cd /etc/nginx/ssl/certs
   #+END_SRC
   +. Copy your .crt, .key, and .ca-bundle file in /etc/nginx/ssl/certs. Create directory *certs* if it does not exist.
   +. Change directory
   #+BEGIN_SRC command
   cd /etc/nginx/sites-enabled
   #+END_SRC
   +. Open file insigts and make following changes in server block of file 
   #+BEGIN_SRC command
   a. vim insights
   b. server_name your-server-domain-name;
   c. ssl_certificate /path/to/your/crt/file/.crt;
   d. ssl_certificate_key /path/to/your/key/file/.key;
   #+END_SRC 
   +. Restart ngnix services 
   #+BEGIN_SRC command
   service ngnix restart 
   #+END_SRC
   + Restart services of edx
   #+BEGIN_SRC command
   sudo /edx/bin/supervisorctl restart all
   #+END_SRC
+ Add certificates in Insights machine ::
  Follow the steps given below to add CA certificate in Insights machine.
  + Install ca-certificate package in ubuntu. Ignore if already installed 
  #+BEGIN_SRC command
  apt-get install ca-certifcate
  #+END_SRC
  + Change directory to /usr/share/ca-certificates/
  #+BEGIN_SRC command
  cd /usr/share/ca-certificates/
  #+END_SRC 
  + Make a directory with name extra in /usr/share/ca-certificates/
  #+BEGIN_SRC command 
  mkdir extra
  #+END_SRC
  + Change directory to /usr/share/ca-certificates/extra
  #+BEGIN_SRC command
  cd /usr/share/ca-certificates/extra
  #+END_SRC
  + Copy your .crt and .ca-bundle files in current directory 
  + Fire command to reconfigure ca-certificates
  #+BEGIN_SRC command
  sudo dpkg-reconfigure ca-certificates
  #+END_SRC
  + A GUI will appear. At the top, a certificate will be listed in the form
    extra/your-crt-file.crt.
  + Press <SPACE BAR> to select the certificate and Press <ENTER> 
  + Fire command to update ca-certificates
  #+BEGIN_SRC command
  sudo update-ca-certificates
  #+END_SRC
  + Install package certifi==2015.04.28. We are no sure , whether this package
    is required in functioning or not. 
  #+BEGIN_SRC command
  sudo pip install certifi==2015.04.28
  #+END_SRC
  + Restart insights services 
  #+BEGIN_SRC command
  sudo /edx/bin/supervisorctl restart all 
  #+END_SRC
+ Edit open_id.py file in insights machines ::
  Follow the steps to edit the open_id.py file in insights machine
 
  + Login into Insights machine
  + Fire command locate to find the path of open_id.py file
  #+BEGIN_SRC command
  insights # locate open_id.py
  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.py
  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.pyc
  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/tests/backends/open_id.py
  /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/tests/backends/open_id.pyc
  #+END_SRC
  + Open file
  #+BEGIN_SRC command
  vim /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/open_id.py
  #+END_SRC
  + Search for string "issuer=self.ID_TOKEN_ISSUER". This string will fall in
    def validate_and_return_id_token of file.
  + In try block replace 
  #+BEGIN_SRC command
  id_token = jwt_decode(id_token, decryption_key, audience=client_id,
                                  issuer=self.ID_TOKEN_ISSUER,
                                  algorithms=['HS256'])

                       WITH

  id_token = jwt_decode(id_token, decryption_key, audience=client_id,
                                  issuer=self.ID_TOKEN_ISSUER, options = {'verify_iat' : False,},
                                  algorithms=['HS256'])

  #+END_SRC
  + Save file
  + Compile open_id.py files 
  #+BEGIN_SRC command
  insights # sudo python
  Python 2.7.10 (default, Jun 29 2015, 22:38:23) 
  [GCC 4.6.3] on linux2
  Type "help", "copyright", "credits" or "license" for more information.
  >>> import py_compile
  >>> py_compile.compile("open_id.py")
  >>> exit()
  #+END_SRC
  + Restart edx services
  #+BEGIN_SRC command
  sudo /edx/bin/supervisorctl restart all 
  #+END_SRC
+ Edit base.py file in insights machine ::

  + Login into Insights machine
  + Open file
  #+BEGIN_SRC command
  vim /edx/app/insights/venvs/insights/lib/python2.7/site-packages/social/backends/base.py
  #+END_SRC
  + In def request(self, url, method='GET', *args, **kwargs):, add the
    following line. This line says that please do not verify SSL.
  #+BEGIN_SRC command
  kwargs.setdefault('headers', {})
  if self.setting('VERIFY_SSL') is not None:
        kwargs.setdefault('verify', self.setting('VERIFY_SSL'))
  kwargs.setdefault('verify', False) #Added by Dr. Ramesh. Add this line as it is.
  kwargs.setdefault('timeout', self.setting('REQUESTS_TIMEOUT') or
                                     self.setting('URLOPEN_TIMEOUT'))
  #+END_SRC
  + In the same def in try block, replace as shown. This is to ignore
    SSL_PROTOCOL even if it is there.
  #+BEGIN_SRC command
  if self.SSL_PROTOCOL
        WITH
  if self.SSL_PROTOCOL is not None:
  #+END_SRC
  + In the same try block, add line in else section 
  #+BEGIN_SRC command
  else:
      response = request(method, url, *args, **kwargs) #Added by Dr. Ramesh
  #+END_SRC
  + Finally your def function looks like the one shown below. Please see the
    commented lines.
  #+BEGIN_SRC command
  def request(self, url, method='GET', *args, **kwargs):
        kwargs.setdefault('headers', {})
        if self.setting('VERIFY_SSL') is not None:
            kwargs.setdefault('verify', self.setting('VERIFY_SSL'))
        kwargs.setdefault('verify', False) #Added by Dr. Ramesh
        kwargs.setdefault('timeout', self.setting('REQUESTS_TIMEOUT') or
                                     self.setting('URLOPEN_TIMEOUT'))
        if self.SEND_USER_AGENT and 'User-Agent' not in kwargs['headers']:
            kwargs['headers']['User-Agent'] = user_agent()

        try:
            if self.SSL_PROTOCOL is not None: #Modified to not none
                #session = SSLHttpAdapter.ssl_adapter_session(self.SSL_PROTOCOL)
                #response = session.request(method, url, *args, **kwargs)
                response = request(method, url, *args, **kwargs)
            else:
                response = request(method, url, *args, **kwargs) #Added by Dr. Ramesh
        except ConnectionError as err:
            raise AuthFailed(self, str(err))
        response.raise_for_status()
        return response
  #+END_SRC
  + Save file and compile it.
 #+BEGIN_SRC command
  insights # sudo python
  Python 2.7.10 (default, Jun 29 2015, 22:38:23) 
  [GCC 4.6.3] on linux2
  Type "help", "copyright", "credits" or "license" for more information.
  >>> import py_compile
  >>> py_compile.compile("base.py")
  >>> exit()
  #+END_SRC
  + Restart edx services
  #+BEGIN_SRC command
  sudo /edx/bin/supervisorctl restart all 
  #+END_SRC
    
* References
  - https://github.com/edx/configuration/wiki
  - https://openedx.atlassian.net/wiki/display/OPEN/Debugging+Issues+with+LMS+and+Studio
  - https://github.com/edx/edx-analytics-pipeline/wiki
  - http://edx.readthedocs.org/projects/edx-installing-configuring-and-running/en/latest/analytics/install_analytics.html
  - https://github.com/open-craft/edx-analytics-devstack
      
* Acknowledgments 
We acknowledge the valuable support of Dr. Ramesh NPN from APSSDC to help us identify and
solve problems we were facing during setting up edx-analytics. We also thank
Mrs. Sukla Nag from IIT-B for her appropriate suggestions.
